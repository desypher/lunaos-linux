#!/bin/sh

case "$1" in
    start)
        echo "Starting LunaOS Desktop..."
        
        # Create required directories
        mkdir -p /tmp/runtime-$USER
        chmod 700 /tmp/runtime-$USER
        chown $USER:$USER /tmp/runtime-$USER
        
        # QT configurations
        export QT_QPA_PLATFORM=xcb
        export QT_XCB_GL_INTEGRATION=xcb_egl
        export DISPLAY=:0
        export XDG_RUNTIME_DIR=/tmp/runtime-$USER
        export QT_LOGGING_RULES="qt.qpa.*=true;qt.qpa.input*=true"
        export QT_QPA_FONTDIR=/usr/share/fonts
        
        # Audio configurations
        export PULSE_SERVER=unix:/run/user/1000/pulse/native
        export ALSA_CARD=Intel
        
        # Wait for X server to be ready
        for i in $(seq 1 10); do
            if DISPLAY=:0 xdpyinfo >/dev/null 2>&1; then
                break
            fi
            sleep 1
        done
        
        # Start LunaOS
        /usr/bin/lunaos &
        ;;
        
    stop)
        echo "Stopping LunaOS Desktop..."
        killall Xvfb
        killall lunaos
        ;;
        
    restart)
        $0 stop
        sleep 1
        $0 start
        ;;
        
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit 0